# Llama-3 LLMサービス用 Dockerfile
FROM python:3.11-slim

# 基本パッケージのインストール
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Ollamaのインストール
RUN curl -fsSL https://ollama.com/install.sh | sh

# Python環境設定
RUN pip install --upgrade pip

# 作業ディレクトリ
WORKDIR /app

# LLM関連の依存関係
COPY requirements/llm.txt /app/requirements.txt
RUN pip install -r requirements.txt

# アプリケーションコードをコピー
COPY services/llm/ /app/

# Ollamaデータディレクトリ
RUN mkdir -p /root/.ollama

# ポート開放
EXPOSE 8002 11434

# ヘルスチェック
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8002/health || exit 1

# 起動スクリプト
COPY docker/start-llm.sh /start-llm.sh
RUN chmod +x /start-llm.sh

# アプリケーション起動
CMD ["/start-llm.sh"]